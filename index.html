<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>You've Been Invited to SEELE AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Inter:wght@400;700&family=Source+Serif+4:opsz,wght@8..60,600&display=swap"
      rel="stylesheet"
    />
    <style>
      body { font-family: 'Inter', sans-serif; }
      .font-serif-display { font-family: 'Source Serif 4', serif; }
      .font-cursive { font-family: 'Great Vibes', cursive; }
      .bg-curves { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; }
      .curve { position: absolute; border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.05); animation: rotate 40s linear infinite; }
      .curve-1 { width: 150vmax; height: 150vmax; top: -50vmax; right: -50vmax; }
      .curve-2 { width: 120vmax; height: 120vmax; bottom: -60vmax; left: -20vmax; animation-direction: reverse; animation-duration: 50s; }
      @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      .copied-feedback { position: absolute; top: -35px; left: 50%; transform: translateX(-50%); background-color: #059669; color: white; padding: 4px 10px; border-radius: 7px; font-size: 0.875rem; font-weight: 600; opacity: 0; transition: opacity 0.3s ease, top 0.3s ease; white-space: nowrap; pointer-events: none; }
      .copied-feedback.show { opacity: 1; top: -45px; }
      .link-glow { position: relative; text-shadow: 0 0 5px rgba(135, 181, 130, 0.5), 0 0 10px rgba(135, 181, 130, 0.4); animation: glitch 3s linear infinite; }
      @keyframes glitch { 0%, 7%, 9%, 10.5%, 100% { text-shadow: 0 0 5px rgba(135, 181, 130, 0.5), 0 0 10px rgba(135, 181, 130, 0.4); } 7.5%, 9.5%, 11% { text-shadow: 0 0 8px rgba(200, 255, 200, 0.8), 0 0 15px rgba(135, 181, 130, 0.6), -0.5px 0 1px rgba(255,0,0,0.4), 0.5px 0 1px rgba(0,255,255,0.4); } }
      .step-label { font-family: Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif; font-weight: bold; font-size: 1.75rem; color: #ef4444; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
    </style>
  </head>
  <body class="bg-black text-gray-200 flex items-center justify-center min-h-screen p-4 overflow-hidden">
    <div class="bg-curves"><div class="curve curve-1"></div><div class="curve curve-2"></div></div>

    <main class="w-full">
      <div id="loading-state" class="text-center">
        <div class="flex justify-center items-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-gray-400"></div></div>
        <p class="mt-4 text-gray-400">Loading invitation...</p>
      </div>

      <div id="content-state" class="hidden">
        <div class="w-full max-w-5xl mx-auto flex flex-col lg:flex-row items-center justify-center gap-8 lg:gap-16 px-4">
          <div class="w-full max-w-xs sm:max-w-sm shrink-0 flex flex-col gap-4 order-2 lg:order-1">
            <div class="bg-gray-900/50 backdrop-blur-sm p-3 rounded-2xl border border-white/10 shadow-2xl">
              <div class="aspect-[3/4] rounded-lg overflow-hidden relative"><video src="https://ik.imagekit.io/dwovit2u8/0_1080_N.mp4?updatedAt=1758822992574" autoplay loop muted playsinline class="w-full h-full object-cover"></video></div>
            </div>
            <div class="flex justify-center items-center gap-6 mt-2">
              <a href="https://x.com/SEELE_AI1125" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg></a>
              <a href="https://discord.gg/SbgbQFq2tb" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors"><svg class="w-7 h-7" role="img" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><title>Discord</title><path d="M20.317 4.369a19.791 19.791 0 00-4.958-1.522c-.468.615-.882.93-1.203.93-1.104 0-2.155-.788-3.258-.788s-2.155.788-3.258.788c-.321 0-.735-.315-1.203-.93a19.791 19.791 0 00-4.958 1.522c-.006.014-.018.028-.024.042a18.238 18.238 0 00-2.754 11.77c.012.028.024.056.042.084 2.16 1.944 4.962 3.204 8.04 3.204s5.88-1.26 8.04-3.204a.06.06 0 00.042-.084 18.238 18.238 0 00-2.754-11.77c-.006-.014-.018-.028-.024-.042zM8.02 15.33c-1.104 0-2.001-.89-2.001-1.986s.897-1.986 2.001-1.986c1.104 0 2.001.89 2.001 1.986s-.897 1.986-2.001 1.986zm7.984 0c-1.104 0-2.001-.89-2.001-1.986s.897-1.986 2.001-1.986c1.104 0 2.001.89 2.001 1.986s-.897 1.986-2.001 1.986z"/></svg></a>
            </div>
          </div>
          <div class="flex flex-col items-center lg:items-start text-center lg:text-left order-1 lg:order-2">
            <h1 class="font-serif-display text-4xl sm:text-5xl font-semibold text-white leading-tight">You've been invited<br />to SEELE AI</h1>
            <p class="mt-8 text-gray-400">Invited by</p>
            <div class="mt-2 flex items-center gap-4">
              <img id="kol-photo" src="" alt="KOL Avatar" class="w-16 h-16 rounded-full object-cover border-2 border-white/30 shadow-md"/>
              <strong id="kol-name" class="font-cursive text-5xl text-white tracking-wide"></strong>
            </div>
            <div id="action-container" class="mt-10 w-full">
              <div id="initial-state">
                <button id="claim-button" class="w-full max-w-xs mx-auto lg:mx-0 flex items-center justify-center gap-3 bg-white/10 hover:bg-white/20 border border-white/20 backdrop-blur-md text-white font-bold text-lg px-8 py-3 rounded-lg shadow-lg transition-all duration-300 transform hover:scale-105">
                  <span>Claim Invite</span>
                </button>
              </div>
              <div id="revealed-state" class="hidden">
                
                <p class="step-label">Step 1</p>
                <p class="text-sm text-gray-400 mt-1">Your invite code (paste this on the website):</p>
                <div class="mt-2 flex items-center justify-between bg-gray-900/80 border border-white/20 rounded-lg p-3 max-w-xs mx-auto lg:mx-0">
                  <span id="invite-code" class="text-2xl font-mono font-bold text-white tracking-widest"></span>
                  <button id="copy-button" class="relative text-gray-400 hover:text-white">
                    <div class="copied-feedback">Copied!</div>
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                  </button>
                </div>

                <div class="mt-8">
                    <p class="step-label">Step 2</p>
                    <div class="mt-2 flex flex-col items-center lg:items-start gap-3">
                      <a id="continue-link" href="#" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-[#87b582] font-semibold transition-colors hover:underline link-glow">
                          <span>Build Your Worlds Now on SEELE AI</span>
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>
                      </a>
                      
                      <a id="preview-link" href="#" target="_blank" rel="noopener noreferrer" class="w-full max-w-xs mx-auto lg:mx-0 block border border-white/20 rounded-lg overflow-hidden group hover:border-white/40 transition-all duration-300 shadow-lg mt-2">
                        <div class="bg-gray-800 p-2 border-b border-white/10 flex items-center gap-1.5">
                            <span class="w-3 h-3 bg-red-500 rounded-full"></span>
                            <span class="w-3 h-3 bg-yellow-500 rounded-full"></span>
                            <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                        </div>
                        <div class="p-4 bg-gray-900/50 backdrop-blur-sm">
                            <p class="text-white font-semibold text-left">SEELE AI</p>
                            <p class="text-gray-400 text-sm mt-1 text-left">Enter your invite code to begin...</p>
                            <div class="mt-3 h-10 bg-gray-800 border border-white/10 rounded flex items-center justify-center px-2">
                               <span id="preview-code-placeholder" class="text-gray-300 font-mono tracking-widest text-lg truncate"></span>
                            </div>
                        </div>
                      </a>

                      <a href="#" class="text-sm text-gray-500 underline hover:text-gray-300 transition-colors mt-2">How to use the Invite Code?</a>
                   </div>
                </div>

                </div>
            </div>
          </div>
        </div>
      </div>
      <div id="error-state" class="hidden text-center max-w-md mx-auto">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-900/50 border border-red-500/30"><svg class="h-6 w-6 text-red-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></div>
        <h2 id="error-title" class="mt-4 text-xl font-bold text-red-400">Oops! Something went wrong.</h2>
        <p id="error-message" class="mt-2 text-red-300 bg-red-900/50 p-3 rounded-md border border-red-500/30"></p>
      </div>
    </main>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const loadingState = document.getElementById('loading-state');
        const contentState = document.getElementById('content-state');
        const errorState = document.getElementById('error-state');
        const errorTitle = document.getElementById('error-title');
        const errorMessage = document.getElementById('error-message');
        const kolPhoto = document.getElementById('kol-photo');
        const kolName = document.getElementById('kol-name');
        const inviteCodeElem = document.getElementById('invite-code');
        const continueLink = document.getElementById('continue-link');
        const claimButton = document.getElementById('claim-button');
        const initialState = document.getElementById('initial-state');
        const revealedState = document.getElementById('revealed-state');
        const copyButton = document.getElementById('copy-button');
        // --- ADDED FOR NEW FEATURES ---
        const previewLink = document.getElementById('preview-link');
        const previewCodePlaceholder = document.getElementById('preview-code-placeholder');

        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby42z--ewLYgCKlNVL4dzrfgZcvRo5JVnipZnHH-fGl3KrNe4XnOVszrHNKvIEy2aVt/exec';

        const getDeviceId = () => {
          let deviceId = localStorage.getItem('uniqueDeviceId');
          if (!deviceId) {
            deviceId = 'guest-' + crypto.randomUUID();
            localStorage.setItem('uniqueDeviceId', deviceId);
          }
          return deviceId;
        };

        const getKolCode = () => {
          try {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('kol');
          } catch (e) {
            console.warn("Could not parse URL params, falling back to regex.");
            const match = window.location.href.match(/[?&#]kol=([^&#]*)/);
            return match ? decodeURIComponent(match[1]) : null;
          }
        };

        const showError = (title, message) => {
            errorTitle.textContent = title;
            errorMessage.textContent = message;
            loadingState.classList.add('hidden');
            contentState.classList.add('hidden');
            errorState.classList.remove('hidden');
        };

        // --- PHASE 1: Load KOL display info ---
        const loadInitialInfo = async (kolCode) => {
          try {
            const apiUrl = new URL(SCRIPT_URL);
            apiUrl.searchParams.append('action', 'getInfo');
            apiUrl.searchParams.append('kol', kolCode);

            const response = await fetch(apiUrl);
            const data = await response.json();

            if (!response.ok || data.error) {
              throw new Error(data.error || `API request failed (status: ${response.status})`);
            }
            
            kolName.textContent = data.kolName;
            kolPhoto.src = data.kolPhotoUrl;

            loadingState.classList.add('hidden');
            contentState.classList.remove('hidden');

          } catch (error) {
            console.error('Error loading initial info:', error);
            showError('Invitation Not Found', error.message);
          }
        };
        
        // --- PHASE 2: Claim the code on button click ---
        const handleClaim = async () => {
          const originalButtonText = claimButton.textContent;
          claimButton.textContent = 'Claiming...';
          claimButton.disabled = true;

          try {
            const kolCode = getKolCode();
            const deviceId = getDeviceId();
            
            const apiUrl = new URL(SCRIPT_URL);
            apiUrl.searchParams.append('action', 'claimCode');
            apiUrl.searchParams.append('kol', kolCode);
            apiUrl.searchParams.append('deviceId', deviceId);

            const response = await fetch(apiUrl);
            const data = await response.json();

            if (!response.ok || data.error) {
              throw new Error(data.error || `API request failed (status: ${response.status})`);
            }
            
            inviteCodeElem.textContent = data.inviteCode;
            continueLink.href = data.adjustLink;
            // --- ADDED FOR NEW FEATURES ---
            previewLink.href = data.adjustLink;
            previewCodePlaceholder.textContent = data.inviteCode;


            initialState.classList.add('hidden');
            revealedState.classList.remove('hidden');

          } catch (error) {
            console.error('Error claiming code:', error);
            alert(`Error: ${error.message}`); // Use alert for critical errors in the second step
            claimButton.textContent = originalButtonText; // Reset button on error
            claimButton.disabled = false;
          }
        };
        claimButton.addEventListener('click', handleClaim);

        const handleCopy = () => {
          const codeToCopy = inviteCodeElem.textContent;
          if (!codeToCopy) return;
          navigator.clipboard.writeText(codeToCopy).then(() => {
            const feedback = copyButton.querySelector('.copied-feedback');
            feedback.classList.add('show');
            setTimeout(() => { feedback.classList.remove('show'); }, 2000);
          }).catch(err => console.error('Failed to copy code: ', err));
        };
        copyButton.addEventListener('click', handleCopy);

        // --- Main execution ---
        const kolCode = getKolCode();
        if (!kolCode) {
          showError('Invalid Link', 'Could not find an invite code in the URL. Please check the link and try again.');
        } else {
          loadInitialInfo(kolCode);
        }
      });
    </script>
  </body>
</html>
